<hr>

<div class="twelve columns login">

  <!-- Google -->
  <div class="six columns">
    <h4>Google</h4>
<!--        <div class="g-signin2">-->
<!--      <a href='#'>Google</a>-->
<!--        </div>-->
    <div id="signinButton">
      <span
        class="g-signin"
        data-scope="openid email"
        data-clientid="142664284246-to2i582oe0haphekkf0pskfs8jvtkd7k.apps.googleusercontent.com"
        data-redirecturi="postmessage"
        data-accesstype="offline"
        data-cookiepolicy="single_host_origin"
        data-callback="signInCallback"
        data-approvalprompt="force">
      </span>
    </div>
  </div>

  <!-- Facebook -->
  <div class="six columns">
    <h4>Facebook</h4>
    <fb:login-button
      scope="public_profile,email"
      onlogin="sendTokenToServer();">
      <a href='javascript:sendTokenToServer()'>Login with Facebook</a>
    </fb:login-button>
    <div id="fb-status"></div>
  </div>

  <div id="loginResult"></div>

</div>


<script>

function signInCallback(authResponse) {
  if (authResponse.code) {
    $('#signinButton').hide();
  }
  $.ajax({
  	type: 'POST',
  	url: '/gconnect?state={{STATE}}',
  	data: authResponse.code,
  	contentType: 'application/octet-stream; charset=utf-8',
  	processData: false,
  	success: function(response) {
    	var message;
  		if (response) {
    		message = '<strong>Login successful!</strong><br>' + response + '<br>Redirecting you now...';
    		setTimeout(function() {
           window.location.href = "/restaurants";
        }, 3000);
  		} else if (authResponse.error) {
    		message = authResponse.error;
    		console.error(authResponse.error);
  		} else {
    		message = 'Failed to make server-side call. Check your console and connection';
  		}
  		$('#loginResult').html('<p>' + message + '</p>');
  	}
  });
}


function statusChangeCallback(response) {
  console.log('statusChangeCallback');
  console.log(response);
  if (response.status === 'connected') {
    testAPI();
  } else if (response.status === 'not_authorized') {
    console.log('Facebook: ' + 'Please log into this app.');
  } else {

    console.log('Facebook: ' + 'Please log into Facebook.');
  }
}


function checkLoginState() {
  FB.getLoginStatus(function(response) {
    statusChangeCallback(response);
  });
}

window.fbAsyncInit = function() {
  FB.init({
    appId      : '191256295434901',
    cookie     : true,

    xfbml      : true,
    version    : 'v2.2'
  });



  FB.getLoginStatus(function(response) {
    statusChangeCallback(response);
  });
};

(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

function testAPI() {
  console.log('Welcome!  Fetching your information.... ');
  FB.api('/me', function(response) {
    console.log('Successful login for: ' + response.name);
  });
}

function sendTokenToServer() {
  var access_token = FB.getAuthResponse()['accessToken'];
  console.log(access_token)
  console.log('Welcome!  Fetching your information.... ');
  FB.api('/me', function(response) {
    console.log('Successful login for: ' + response.name);
    $.ajax({
      type: 'POST',
      url: '/fbconnect?state={{STATE}}',
      processData: false,
      data: access_token,
      contentType: 'application/octet-stream; charset=utf-8',
      success: function(result) {
        // Handle or verify the server response if necessary.
        if (result) {
          $('#loginResult').html('Login Successful!</br>' + result + '</br>Redirecting...')
          setTimeout(function() {
              window.location.href = "/restaurants";
          }, 3000);
        } else {
          $('#loginResult').html('Failed to make a server-side call. Check your configuration and console.');
        }
      }
    });
  });
}

</script>

